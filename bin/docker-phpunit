#!/usr/bin/env bash

php_ip=$(docker inspect --format='{{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}' bagheera_php)
postgresql_ip=$(docker inspect --format='{{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}' bagheera_postgresql)

if [[ -z $php_ip || -z $postgresql_ip ]]; then
    echo 'IP not found!'
    exit 1
fi

while ! nc -zv "$php_ip" 9000 &>/dev/null; do
    echo 'Waiting for php startup'
    sleep 2
done

while ! nc -zv "$postgresql_ip" 5432 &>/dev/null; do
    echo 'Waiting for postgresql startup'
    sleep 2
done

if ! docker exec -ti bagheera_postgresql psql -U bagheera -lqt | awk '{print $1}' | grep -qw bagheera_test; then
    docker exec -ti bagheera_postgresql createdb -U bagheera bagheera_test
fi

docker exec -ti bagheera_php php bin/phpunit -c /srv/www/bagheera "$@"
